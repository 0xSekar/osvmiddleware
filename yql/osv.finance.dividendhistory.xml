<?xml version="1.0" encoding="UTF-8"?>
    <table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
    <meta>
        <author>
            Sergio Karsvnie
        </author>
        <description>
            Yahoo Finance - Dividend History
        </description>
        <sampleQuery>
            SELECT * FROM osv.finance.dividendhistory WHERE symbol='T' and startDate="2016-02-02" and endDate="2017-02-02"
        </sampleQuery>
    </meta>
    <bindings>
        <select itemPath="" produces="XML">
            <urls>
                <url>
                </url>
            </urls>
            <inputs>
                <key id="symbol" type="xs:string" paramType="variable" required="true" />
                <key id="startDate" type="xs:string" paramType="variable" required="true"/>
                <key id="endDate" type="xs:string" paramType="variable" required="true"/>
            </inputs>
            <execute>
                <![CDATA[
                    // Setup Query from finance.yahoo.com
                    var url="https://finance.yahoo.com/quote/"+symbol+"/history?p="+symbol
                    var restquery = y.rest( url );
                    var rawresult = restquery.accept( "text/html" ).get().response.toString();
                    // Setup Second Query from finance.yahoo.com
                    var period1 = (y.date.getOffsetFromEpochInMillis(startDate)/1000).toFixed(0);
                    var period2 = ((y.date.getOffsetFromEpochInMillis(endDate)/1000)+36000).toFixed(0);
                    var url2 = "https://query2.finance.yahoo.com/v8/finance/chart/"+symbol+"?formatted=true&crumb=Q3iB.HnhxjZ&lang=en-US&region=US&period1="+period1+"&period2="+period2+"&interval=1d&events=div%7Csplit&corsDomain=finance.yahoo.com";
                    var restquery2 = y.rest( url2 );
                    var r2 = restquery2.accept( "application/json" ).get().response;
                    r2 = y.xmlToJson(r2);
                    r2 = r2.chart.result.events.dividends;
                    var rf = {"quote":{}};
                    for (var attrname in r2) {
                        rf.quote[attrname] = {};
                        rf.quote[attrname].Dividends=r2[attrname].amount;
                        rf.quote[attrname].Date=new Date(parseInt(r2[attrname].date * 1000)).toISOString().slice(0,10);
                    }
                    response.object = rf;
                ]]>
            </execute>
        </select>
    </bindings>
</table>
